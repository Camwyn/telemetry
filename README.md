# Telemetry Library

## Dependencies

1. [PHP 7.2](https://www.php.net/)
2. [Composer](https://getcomposer.org/)
3. [WordPress](https://wordpress.org/)
4. [DI52](https://github.com/lucatume/di52/)

## How to install

Install this library as a dependency in your project: `composer require stellarwp/telemetry`.

To use our default implementations, register the following classes in your container:

1. `StellarWP\Telemetry\PluginStarter` as `StellarWP\Telemetry\DefaultPluginStarter`
2. `StellarWP\Telemetry\TelemetryProvider` as `StellarWP\Telemetry\DefaultTelemetryProvider`
3. `StellarWP\Telemetry\ActivationHook` as `StellarWP\Telemetry\DefaultActivationHook`
4. `StellarWP\Telemetry\Template` as `StellarWP\Telemetry\DefaultOptinTemplate`

## How to run

1. Register the activation hook in your plugin's main
   file: `register_activation_hook( __FILE__, [ \Stellar\Telemetry\PluginStarter::class, 'activation_hook' ] );`.

## How to use

Considering you use the provided Default implementations and its a new installation, this is the workflow you can
expect:

1. The plugin is activated.
2. The `activation_hook` is called, which will create a new `PluginStarter` instance and run its constructor.
3. `PluginStarter` will register the cronjob handlers, and do the initial activation redirect.
4. The `stellarwp_telemetry` option will get registered with the current plugin slug's optin status set to false.
5. Once the user lands in any of your plugin's admin pages, if the optin status is false, the user will be presented
   with the optin dialog.
6. If the user opts in, the `stellarwp_telemetry` option will be updated and override all plugin slugs' optin status to
   true.
7. An initial request will be sent immediately after the user opts in, and the cronjob will be scheduled to run weekly
   by default.
8. The initial request will send the authenticated user's name and email, as well as the WP_Debug_Data, and will get a
   response with the site's newly assigned token (Generated by the Telemetry Server, and stored in
   the `stellarwp_telemetry` option)
9. The cronjob will send WP_Debug_Data to the provided telemetry server URL using the stored site token in the `stellarwp_telemetry` option.